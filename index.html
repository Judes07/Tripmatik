<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ömoş Tripmatik - Online</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React ve ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-pink-100 via-rose-50 to-purple-100 min-h-screen">
    
    <!-- Başlangıçta görünecek yükleme ekranı -->
    <div id="root" class="flex flex-col items-center justify-center min-h-screen text-rose-500">
        <div class="text-2xl font-bold mb-2">Ömoş Tripmatik Hazırlanıyor...</div>
        <div class="loading-dots text-sm opacity-75">Sistem yükleniyor</div>
    </div>

    <!-- Hata Yakalayıcı -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const root = document.getElementById('root');
            let friendlyMsg = msg;
            
            // Hata mesajlarını Türkçeleştirme
            if (msg.includes("Firebase config")) friendlyMsg = "Veritabanı ayarları eksik veya hatalı.";
            if (msg.includes("permission-denied")) friendlyMsg = "Veritabanı izni reddedildi. Firebase konsolundan Firestore kurallarını kontrol edin.";
            if (msg.includes("auth/configuration-not-found") || msg.includes("auth/operation-not-allowed")) {
                friendlyMsg = "Giriş yapılamadı. Firebase Konsolunda 'Authentication' -> 'Sign-in method' kısmından 'Anonymous' (Anonim) seçeneğini etkinleştirdiğinizden emin olun.";
            }
            
            root.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-xl max-w-md mx-4 border-l-4 border-red-500">
                    <h3 class="text-xl font-bold text-red-600 mb-2">Bir Hata Oluştu!</h3>
                    <p class="text-gray-700 mb-4 text-sm">${friendlyMsg}</p>
                    <div class="bg-gray-100 p-3 rounded text-xs text-gray-500 font-mono break-all">
                        Teknik Detay: ${msg}
                    </div>
                </div>
            `;
            return false;
        };
    </script>

    <!-- 1. ADIM: Firebase Modüllerini Yükle ve Global Yap -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // =================================================================
        // SENİN FIREBASE AYARLARIN
        // =================================================================
        const SENIN_FIREBASE_AYARLARIN = {
             apiKey: "AIzaSyA9wecBOHX9-qtvjKgu8MPoHEb_ld-LC44",
             authDomain: "trip-64cb9.firebaseapp.com",
            projectId: "trip-64cb9",
            storageBucket: "trip-64cb9.firebasestorage.app",
            messagingSenderId: "580909327374",
            appId: "1:580909327374:web:ce9d449e00d7b23e14885f",
            measurementId: "G-1H5W71PNXY"
        };
        
        // Config Belirleme Mantığı
        let firebaseConfig;
        let activeAppId = 'omos-trip-app';
        let useEnvToken = true; // Varsayılan olarak ortam token'ını kullanmaya çalış

        try {
            if (SENIN_FIREBASE_AYARLARIN) {
                // Senin ayarlarını kullan
                firebaseConfig = SENIN_FIREBASE_AYARLARIN;
                // Kendi projemizi kullanıyoruz, ortam token'ını KESİNLİKLE yoksaymalıyız
                // Çünkü o token bu projeye ait değil.
                useEnvToken = false; 
            } else if (typeof __firebase_config !== 'undefined') {
                // Yedek (Test ortamı)
                firebaseConfig = JSON.parse(__firebase_config);
                if (typeof __app_id !== 'undefined') activeAppId = __app_id;
            } else {
                throw new Error("Firebase config bulunamadı.");
            }
        } catch (e) {
            console.error("Firebase Kurulum Hatası:", e);
            throw e;
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Analytics başlatma
        try {
            const analytics = getAnalytics(app);
        } catch (e) {
            console.log("Analytics başlatılamadı (önemsiz):", e);
        }

        window.Firebase = {
            auth, db, appId: activeAppId,
            signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp,
            // Eğer kendi config'imizi kullanıyorsak initialToken'ı null yapıyoruz
            initialToken: (typeof __initial_auth_token !== 'undefined' && useEnvToken) ? __initial_auth_token : null
        };

        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- 2. ADIM: React Uygulaması -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // İkonlar
        const Icons = {
            HeartCrack: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/><path d="m12 13-3-3 2-2-1.5-1.5"/></svg>
            ),
            Plus: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="M12 5v14"/></svg>
            ),
            Trash2: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
            ),
            Zap: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            ),
            AlertCircle: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
            ),
            Sparkles: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>
            ),
            Cloud: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M20.97 19h1.53a4.5 4.5 0 0 0 .56-8.97A9.04 9.04 0 0 0 8 9.32a7.5 7.5 0 0 0-3.5 14.18H17.5"/></svg>
            ),
            Heart: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
            )
        };

        function App() {
            const [trips, setTrips] = useState([]);
            const [newReason, setNewReason] = useState("");
            const [newAction, setNewAction] = useState("");
            const [intensity, setIntensity] = useState(5);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            // Firebase'i güvenli şekilde al
            const fb = window.Firebase;

            useEffect(() => {
                if (!fb) return;
                
                const initAuth = async () => {
                    try {
                        // Eğer custom config kullanıyorsak initialToken null olacaktır
                        // Bu durumda direkt signInAnonymously çalışır
                        if (fb.initialToken) {
                            await fb.signInWithCustomToken(fb.auth, fb.initialToken);
                        } else {
                            await fb.signInAnonymously(fb.auth);
                        }
                    } catch (err) {
                        console.error("Giriş hatası:", err);
                    }
                };
                initAuth();
                
                const unsubscribe = fb.onAuthStateChanged(fb.auth, (currentUser) => {
                    setUser(currentUser);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !fb) return;

                const collectionPath = 'omos_trips'; 
                
                const q = fb.query(fb.collection(fb.db, collectionPath));
                
                const unsubscribe = fb.onSnapshot(q, (snapshot) => {
                    const loadedTrips = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // Tarihe göre sırala
                    loadedTrips.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    
                    setTrips(loadedTrips);
                    setLoading(false);
                }, (error) => {
                    console.error("Veri çekme hatası:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            const handleAddTrip = async () => {
                if (!newReason || !newAction || !user) return;
                
                try {
                    await fb.addDoc(fb.collection(fb.db, 'omos_trips'), {
                        reason: newReason,
                        action: newAction,
                        date: new Date().toLocaleDateString('tr-TR'),
                        intensity: intensity,
                        timestamp: fb.serverTimestamp(),
                        creatorId: user.uid
                    });
                    setNewReason("");
                    setNewAction("");
                    setIntensity(5);
                } catch (error) {
                    console.error("Hata:", error);
                    alert("Kayıt başarısız oldu. Firestore kurallarını kontrol edin.");
                }
            };

            const randomReasons = [
                { r: "Rüyamda beni aldattığını gördüm.", a: "Sabah uyanınca yüzüne bakılmadı, kapılar sert kapatıldı." },
                { r: "Instagram'da o kızın fotosunu beğenmiş.", a: "Bütün fotoğrafları arşivlendi, biyografi silindi." },
                { r: "Acıktım ama ne yiyeceğimi o da bilmiyor.", a: "'Sen beni hiç düşünmüyorsun' nutuğu çekildi." },
                { r: "Bana 'sen bilirsin' dedi.", a: "Kıyamet koparıldı." },
                { r: "Nefes alışı çok gürültülüydü.", a: "Odayı terk etme eylemi gerçekleştirildi." },
                { r: "Canım sıkıldı, kaos lazım.", a: "Eski defterler açıldı, 2019'daki hatası hatırlatıldı." }
            ];

            const handleRandomTrip = () => {
                // SADECE STATE GÜNCELLİYORUZ (Kutucukları dolduruyoruz)
                const random = randomReasons[Math.floor(Math.random() * randomReasons.length)];
                setNewReason(random.r);
                setNewAction(random.a);
                setIntensity(Math.floor(Math.random() * 5) + 5);
                // Burada veritabanı kayıt işlemi YOK
            };

            const handleDelete = async (id) => {
                if(!user) return;
                try {
                    await fb.deleteDoc(fb.doc(fb.db, 'omos_trips', id));
                } catch (error) { console.error(error); }
            };

            const getIntensityColor = (level) => {
                if (level <= 3) return "bg-blue-100 text-blue-700 border-blue-200";
                if (level <= 7) return "bg-orange-100 text-orange-700 border-orange-200";
                return "bg-red-100 text-red-700 border-red-200 animate-pulse";
            };

            return (
                <div className="p-4">
                    <div className="max-w-md mx-auto space-y-6">
                        {/* Header */}
                        <header className="text-center py-6 bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-pink-200 sticky top-4 z-10 relative overflow-hidden">
                            <div className="absolute top-2 right-2 flex items-center gap-1 bg-green-100 px-2 py-1 rounded-full border border-green-200">
                                <div className={`w-2 h-2 rounded-full ${user ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                                <span className="text-[10px] text-green-700 font-bold uppercase tracking-wider">
                                    {loading ? '...' : 'Online'}
                                </span>
                            </div>
                            <div className="flex justify-center mb-2">
                                <Icons.HeartCrack className="w-12 h-12 text-rose-500 fill-rose-200" />
                            </div>
                            <h1 className="text-3xl font-black text-rose-600 tracking-tight">Ömoş Tripmatik</h1>
                            <p className="text-rose-400 font-medium text-sm mt-1">"Bulutlara yazılan sitemler..."</p>
                        </header>

                        {/* Form */}
                        <div className="bg-white rounded-3xl shadow-lg p-6 border border-pink-100 relative">
                            {!user && (
                                <div className="absolute inset-0 bg-white/80 backdrop-blur-sm z-20 flex items-center justify-center rounded-3xl">
                                    <span className="text-rose-500 font-bold loading-dots">Bağlanıyor</span>
                                </div>
                            )}
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-lg font-bold text-slate-700 flex items-center gap-2">
                                    <Icons.Cloud className="w-5 h-5 text-sky-500" />
                                    Yeni Trip Yükle
                                </h2>
                                <button onClick={handleRandomTrip} className="text-xs bg-purple-100 text-purple-600 px-3 py-1 rounded-full font-bold hover:bg-purple-200 flex items-center gap-1">
                                    <Icons.Zap size={14} /> Otomatik
                                </button>
                            </div>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-1 uppercase">Trip Sebebi</label>
                                    <textarea value={newReason} onChange={(e) => setNewReason(e.target.value)} placeholder="Örn: Mesajıma 'ok' yazdı..." className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-rose-300 resize-none h-20" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-1 uppercase">Uygulanan Tarife</label>
                                    <input type="text" value={newAction} onChange={(e) => setNewAction(e.target.value)} placeholder="Örn: 2 saat sessiz kalındı." className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-rose-300" />
                                </div>
                                <div>
                                    <div className="flex justify-between mb-1">
                                        <label className="text-xs font-bold text-slate-400 uppercase">Şiddet</label>
                                        <span className="text-xs font-bold text-rose-500">{intensity}/10</span>
                                    </div>
                                    <input type="range" min="1" max="10" value={intensity} onChange={(e) => setIntensity(Number(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-rose-500" />
                                </div>
                                <button onClick={handleAddTrip} disabled={!newReason || !newAction} className="w-full bg-rose-500 hover:bg-rose-600 disabled:opacity-50 text-white font-bold py-3 rounded-xl transition-all shadow-md flex justify-center items-center gap-2">
                                    <Icons.Plus size={20} /> Listeye Ekle
                                </button>
                            </div>
                        </div>

                        {/* Liste */}
                        <div className="space-y-4 pb-12">
                            <h3 className="text-slate-500 font-bold ml-2 text-sm uppercase tracking-wider">Kayıtlar</h3>
                            {loading ? (
                                <div className="text-center py-8 text-rose-400 font-bold loading-dots">Yükleniyor</div>
                            ) : trips.length === 0 ? (
                                <div className="text-center py-10 bg-white/50 rounded-3xl border-2 border-dashed border-slate-200">
                                    <Icons.Heart className="w-12 h-12 text-slate-200 mx-auto mb-2" />
                                    <p className="text-slate-400 font-medium">Tertemiz...</p>
                                </div>
                            ) : (
                                trips.map((trip) => (
                                    <div key={trip.id} className="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 relative group">
                                        <div className="absolute top-4 right-4">
                                            <span className={`text-[10px] font-bold px-2 py-1 rounded-full border ${getIntensityColor(trip.intensity)}`}>Seviye: {trip.intensity}</span>
                                        </div>
                                        <div className="pr-16">
                                            <div className="text-xs font-bold text-slate-400 mb-1 flex items-center gap-1">
                                                <Icons.AlertCircle size={12} /> {trip.date}
                                            </div>
                                            <h4 className="font-bold text-slate-800 text-lg leading-tight mb-2">"{trip.reason}"</h4>
                                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                                <p className="text-slate-600 text-sm italic"><span className="font-bold text-rose-400 not-italic">Sonuç: </span>{trip.action}</p>
                                            </div>
                                        </div>
                                        <button onClick={() => handleDelete(trip.id)} className="absolute bottom-4 right-4 p-2 text-slate-300 hover:text-red-500 rounded-full transition-colors">
                                            <Icons.Trash2 size={18} />
                                        </button>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const initApp = () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        };

        if (window.Firebase) {
            initApp();
        } else {
            window.addEventListener('firebase-ready', initApp);
            // 3 Saniye içinde Firebase yüklenmezse yine de dene
            setTimeout(() => {
                if (!window.Firebase) console.warn("Firebase gecikti...");
            }, 3000);
        }
    </script>
</body>
</html>
